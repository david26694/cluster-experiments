
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Functions to design and run clustered experiments">
      
      
        <meta name="author" content="David Masip">
      
      
        <link rel="canonical" href="https://david26694.github.io/cluster-experiments/api/experiment_analysis.html">
      
      
        <link rel="prev" href="../e2e_mde_delta.html">
      
      
        <link rel="next" href="perturbator.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>Experiment analysis methods - Cluster Experiments Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../style.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#from-cluster_experimentsexperiment_analysis-import" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cluster Experiments Docs" class="md-header__button md-logo" aria-label="Cluster Experiments Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cluster Experiments Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Experiment analysis methods
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/david26694/cluster-experiments" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cluster Experiments Docs" class="md-nav__button md-logo" aria-label="Cluster Experiments Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Cluster Experiments Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/david26694/cluster-experiments" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../e2e_mde.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    End-to-end example
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cupac_example.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cupac example
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../create_custom_classes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom classes
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Switchback
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Switchback
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../switchback.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stratified switchback
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_calendars.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Switchback calendar visualization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_calendars_hours.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualization - 4-hour switches
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../e2e_mde_switchback.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    End-to-end example
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../multivariate.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multiple treatments
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../aa_test.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AA test clustered
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../paired_ttest.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Paired T test
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis_with_different_hypotheses.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Power comparison under different hypotheses
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../washover_example.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Washover
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Normal Power
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Normal Power
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../normal_power.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compare with simulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../normal_power_lines.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Time-lines
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../synthetic_control.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Synthetic Control
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../experiment_analysis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Experiment Analysis
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Delta method
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Delta method
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../delta_method.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Delta Method Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../e2e_mde_delta.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    End-to-end example
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" checked>
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Experiment analysis methods
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="experiment_analysis.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Experiment analysis methods
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      experiment_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      ClusteredOLSAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ClusteredOLSAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.fit_ols" class="md-nav__link">
    <span class="md-ellipsis">
      fit_ols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ConfidenceInterval" class="md-nav__link">
    <span class="md-ellipsis">
      ConfidenceInterval
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      DeltaMethodAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DeltaMethodAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__check_data_is_aggregated" class="md-nav__link">
    <span class="md-ellipsis">
      __check_data_is_aggregated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._aggregate_to_cluster" class="md-nav__link">
    <span class="md-ellipsis">
      _aggregate_to_cluster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._compute_thetas" class="md-nav__link">
    <span class="md-ellipsis">
      _compute_thetas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._correct_target" class="md-nav__link">
    <span class="md-ellipsis">
      _correct_target
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_group_mean_and_variance" class="md-nav__link">
    <span class="md-ellipsis">
      _get_group_mean_and_variance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_mean_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      _get_mean_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_num_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      _get_num_clusters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance" class="md-nav__link">
    <span class="md-ellipsis">
      _get_ratio_variance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_cuped" class="md-nav__link">
    <span class="md-ellipsis">
      _get_ratio_variance_cuped
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple" class="md-nav__link">
    <span class="md-ellipsis">
      _get_ratio_variance_simple
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_get_ratio_variance_simple">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates" class="md-nav__link">
    <span class="md-ellipsis">
      _add_interaction_covariates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_add_interaction_covariates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--args" class="md-nav__link">
    <span class="md-ellipsis">
      Args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._create_binary_treatment" class="md-nav__link">
    <span class="md-ellipsis">
      _create_binary_treatment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._data_checks" class="md-nav__link">
    <span class="md-ellipsis">
      _data_checks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._get_cluster_column" class="md-nav__link">
    <span class="md-ellipsis">
      _get_cluster_column
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      get_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      get_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      get_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      get_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.pvalue_based_on_hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      pvalue_based_on_hypothesis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      GeeExperimentAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GeeExperimentAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.fit_gee" class="md-nav__link">
    <span class="md-ellipsis">
      fit_gee
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.InferenceResults" class="md-nav__link">
    <span class="md-ellipsis">
      InferenceResults
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      MLMExperimentAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MLMExperimentAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.fit_mlm" class="md-nav__link">
    <span class="md-ellipsis">
      fit_mlm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      OLSAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OLSAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.fit_ols" class="md-nav__link">
    <span class="md-ellipsis">
      fit_ols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      PairedTTestClusteredAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PairedTTestClusteredAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      SyntheticControlAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SyntheticControlAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._fit" class="md-nav__link">
    <span class="md-ellipsis">
      _fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._get_treatment_cluster" class="md-nav__link">
    <span class="md-ellipsis">
      _get_treatment_cluster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._predict" class="md-nav__link">
    <span class="md-ellipsis">
      _predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._split_pre_experiment_df" class="md-nav__link">
    <span class="md-ellipsis">
      _split_pre_experiment_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.fit_predict_synthetic" class="md-nav__link">
    <span class="md-ellipsis">
      fit_predict_synthetic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.pvalue_based_on_hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      pvalue_based_on_hypothesis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      TTestClusteredAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TTestClusteredAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="perturbator.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Perturbators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="random_splitter.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Splitter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cupac_model.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pre experiment outcome model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="power_config.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Power config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="power_analysis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Power analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="washover.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Washover
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="metric.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="variant.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Variant
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dimension.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dimension
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="hypothesis_test.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hypothesis Test
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="analysis_plan.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analysis Plan
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      experiment_analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      ClusteredOLSAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ClusteredOLSAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.fit_ols" class="md-nav__link">
    <span class="md-ellipsis">
      fit_ols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ConfidenceInterval" class="md-nav__link">
    <span class="md-ellipsis">
      ConfidenceInterval
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      DeltaMethodAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DeltaMethodAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__check_data_is_aggregated" class="md-nav__link">
    <span class="md-ellipsis">
      __check_data_is_aggregated
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._aggregate_to_cluster" class="md-nav__link">
    <span class="md-ellipsis">
      _aggregate_to_cluster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._compute_thetas" class="md-nav__link">
    <span class="md-ellipsis">
      _compute_thetas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._correct_target" class="md-nav__link">
    <span class="md-ellipsis">
      _correct_target
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_group_mean_and_variance" class="md-nav__link">
    <span class="md-ellipsis">
      _get_group_mean_and_variance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_mean_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      _get_mean_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_num_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      _get_num_clusters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance" class="md-nav__link">
    <span class="md-ellipsis">
      _get_ratio_variance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_cuped" class="md-nav__link">
    <span class="md-ellipsis">
      _get_ratio_variance_cuped
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple" class="md-nav__link">
    <span class="md-ellipsis">
      _get_ratio_variance_simple
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_get_ratio_variance_simple">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates" class="md-nav__link">
    <span class="md-ellipsis">
      _add_interaction_covariates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_add_interaction_covariates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--args" class="md-nav__link">
    <span class="md-ellipsis">
      Args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._create_binary_treatment" class="md-nav__link">
    <span class="md-ellipsis">
      _create_binary_treatment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._data_checks" class="md-nav__link">
    <span class="md-ellipsis">
      _data_checks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._get_cluster_column" class="md-nav__link">
    <span class="md-ellipsis">
      _get_cluster_column
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      get_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      get_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      get_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      get_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.pvalue_based_on_hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      pvalue_based_on_hypothesis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      GeeExperimentAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GeeExperimentAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.fit_gee" class="md-nav__link">
    <span class="md-ellipsis">
      fit_gee
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.InferenceResults" class="md-nav__link">
    <span class="md-ellipsis">
      InferenceResults
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      MLMExperimentAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MLMExperimentAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.fit_mlm" class="md-nav__link">
    <span class="md-ellipsis">
      fit_mlm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      OLSAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OLSAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_confidence_interval" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_confidence_interval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_inference_results" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_inference_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_standard_error" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_standard_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.fit_ols" class="md-nav__link">
    <span class="md-ellipsis">
      fit_ols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.OLSAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      PairedTTestClusteredAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PairedTTestClusteredAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      SyntheticControlAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SyntheticControlAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._fit" class="md-nav__link">
    <span class="md-ellipsis">
      _fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._get_treatment_cluster" class="md-nav__link">
    <span class="md-ellipsis">
      _get_treatment_cluster
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._predict" class="md-nav__link">
    <span class="md-ellipsis">
      _predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._split_pre_experiment_df" class="md-nav__link">
    <span class="md-ellipsis">
      _split_pre_experiment_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_point_estimate" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_point_estimate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.fit_predict_synthetic" class="md-nav__link">
    <span class="md-ellipsis">
      fit_predict_synthetic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.pvalue_based_on_hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      pvalue_based_on_hypothesis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      TTestClusteredAnalysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TTestClusteredAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis.analysis_pvalue" class="md-nav__link">
    <span class="md-ellipsis">
      analysis_pvalue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis.from_config" class="md-nav__link">
    <span class="md-ellipsis">
      from_config
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="from-cluster_experimentsexperiment_analysis-import"><code>from cluster_experiments.experiment_analysis import *</code><a class="headerlink" href="#from-cluster_experimentsexperiment_analysis-import" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="cluster_experiments.experiment_analysis"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.ClusteredOLSAnalysis" class="doc doc-heading">
            <code>ClusteredOLSAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.OLSAnalysis" href="#cluster_experiments.experiment_analysis.OLSAnalysis">OLSAnalysis</a></code></p>


        <p>Class to run OLS clustered analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as covariates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_covariate_interaction</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>bool, if True, adds interaction terms between covariates and treatment</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClusteredOLSAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
<span class="p">})</span>

<span class="n">ClusteredOLSAnalysis</span><span class="p">(</span>
    <span class="n">cluster_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClusteredOLSAnalysis</span><span class="p">(</span><span class="n">OLSAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run OLS clustered analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        covariates: list of columns to use as covariates</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>
<span class="sd">        add_covariate_interaction: bool, if True, adds interaction terms between covariates and treatment</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import ClusteredOLSAnalysis</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    df = pd.DataFrame({</span>
<span class="sd">        &#39;x&#39;: [1, 2, 3, 0, 0, 1, 2, 0],</span>
<span class="sd">        &#39;treatment&#39;: [&quot;A&quot;] * 2 + [&quot;B&quot;] * 2 + [&quot;A&quot;] * 2 + [&quot;B&quot;] * 2,</span>
<span class="sd">        &#39;cluster&#39;: [1, 1, 2, 2, 3, 3, 4, 4],</span>
<span class="sd">    })</span>

<span class="sd">    ClusteredOLSAnalysis(</span>
<span class="sd">        cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">        target_col=&#39;x&#39;,</span>
<span class="sd">    ).get_pvalue(df)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
            <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="n">cluster_cols</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_ols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the fitted OLS model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">cov_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">,</span>
            <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)},</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an OLSAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.fit_ols" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.fit_ols" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the fitted OLS model</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_ols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the fitted OLS model&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">cov_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">,</span>
        <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)},</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.from_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.ClusteredOLSAnalysis.from_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Creates an OLSAnalysis object from a PowerConfig object</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates an OLSAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.ConfidenceInterval" class="doc doc-heading">
            <code>ConfidenceInterval</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.ConfidenceInterval" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Class to define the structure of a confidence interval.</p>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ConfidenceInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to define the structure of a confidence interval.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis" class="doc doc-heading">
            <code>DeltaMethodAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>







              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DeltaMethodAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
    <span class="n">n_clusters_warning_limit</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">scale_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to run the Delta Method approximation for estimating the treatment effect on a ratio metric (target/scale) under a clustered design.</span>
<span class="sd">        The analysis is done on the aggregated data at the cluster level, making computation more efficient.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cluster_cols: list of columns to use as clusters.</span>
<span class="sd">            target_col: name of the column containing the variable to measure (the numerator of the ratio).</span>
<span class="sd">            scale_col: name of the column containing the scale variable (the denominator of the ratio).</span>
<span class="sd">            treatment_col: name of the column containing the treatment variable.</span>
<span class="sd">            treatment: name of the treatment to use as the treated group.</span>
<span class="sd">            covariates: list of columns to use as covariates. Have to be previously aggregated at the cluster level.</span>
<span class="sd">            hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis.</span>

<span class="sd">            Usage:</span>
<span class="sd">            ```python</span>
<span class="sd">            import pandas as pd</span>

<span class="sd">            from cluster_experiments.experiment_analysis import DeltaMethodAnalysis</span>

<span class="sd">            df = pd.DataFrame({</span>
<span class="sd">                &#39;x&#39;: [1, 2, 3, 0, 0, 1] * 2,</span>
<span class="sd">                &#39;y&#39;: [2, 2, 5, 1, 1, 1] * 2,</span>
<span class="sd">                &#39;treatment&#39;: [&quot;A&quot;] * 6 + [&quot;B&quot;] * 6,</span>
<span class="sd">                &#39;cluster&#39;: [1, 2, 3, 1, 2, 3] * 2,</span>
<span class="sd">                &#39;z&#39;: [1, 2, 3, 4, 5, 6] * 2,</span>
<span class="sd">            })</span>

<span class="sd">            DeltaMethodAnalysis(</span>
<span class="sd">                cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">                target_col=&#39;x&#39;,</span>
<span class="sd">                scale_col=&#39;y&#39;,</span>
<span class="sd">                covariates=[&#39;z&#39;]</span>
<span class="sd">            ).get_pvalue(df)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span> <span class="o">=</span> <span class="n">scale_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="n">cluster_cols</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span> <span class="ow">or</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the theta value for the CUPED method.</span>
<span class="sd">        Thetas are computed as the inverse of the covariance matrix of covariates multiplied by the covariance between covariates and target metric.</span>

<span class="sd">        Delta method with CUPED should work like the following. For each randomization unit i we observe $Y_i$, $N_i$.</span>

<span class="sd">        Refer to delta.md for mathematical details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">])</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Code for n = 1 (deng et al)</span>
            <span class="n">Y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">scale</span>

            <span class="c1"># need to covariate * scale to get X_i = covariate_i * N_i</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">])</span>  <span class="c1"># 4</span>

            <span class="n">mu_Y</span><span class="p">,</span> <span class="n">mu_N</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">mu_X</span><span class="p">,</span> <span class="n">mu_M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">M</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">beta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu_N</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_Y</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">beta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu_M</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_X</span> <span class="o">/</span> <span class="n">mu_M</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># formula from Deng et al. n&#39;s would cancel out</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="n">beta2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">theta</span><span class="p">])}</span>

        <span class="c1"># Sample means</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">covariates</span> <span class="o">*</span> <span class="n">scale</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">]),</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mu_Y</span><span class="p">,</span> <span class="n">mu_N</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">mu_X</span><span class="p">,</span> <span class="n">mu_M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span>

        <span class="c1"># numerator (follow delta.md)</span>
        <span class="n">cov_YX</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">cov_NX</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">cov_YN</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">cov_NN</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cov_YX</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">mu_Y</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov_NX</span> <span class="o">/</span> <span class="n">mu_N</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">mu_X</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov_YN</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">mu_X</span> <span class="o">*</span> <span class="n">mu_Y</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov_NN</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># denominator (follow delta.md, K * D * K^T)</span>
        <span class="n">d_matrix</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="mi">2</span><span class="p">:]</span>  <span class="c1"># (k + 1) x (k + 1)</span>
        <span class="n">k_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">k_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu_M</span>
        <span class="n">k_matrix</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu_X</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu_M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">k_matrix</span> <span class="o">@</span> <span class="n">d_matrix</span> <span class="o">@</span> <span class="n">k_matrix</span><span class="o">.</span><span class="n">T</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">denominator</span><span class="p">),</span> <span class="n">numerator</span><span class="p">)</span>
        <span class="c1"># return both theta and pieces for variance calculation</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s2">&quot;numerator&quot;</span><span class="p">:</span> <span class="n">numerator</span><span class="p">,</span> <span class="s2">&quot;denominator&quot;</span><span class="p">:</span> <span class="n">denominator</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ratio_variance_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Variance of the ratio of means (sum(target)/sum(scale)) via delta method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target : array-like</span>
<span class="sd">            Numerator per unit.</span>
<span class="sd">        scale : array-like</span>
<span class="sd">            Denominator per unit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        variance : float</span>
<span class="sd">            Estimated variance of the ratio metric.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">])</span>

        <span class="n">target_mean</span><span class="p">,</span> <span class="n">scale_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

        <span class="c1"># Sample variances and covariance</span>
        <span class="n">var_target</span><span class="p">,</span> <span class="n">var_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cov_target_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Gradient of g(Ȳ, scalē) = Ȳ / scalē</span>
        <span class="n">grad_target</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">scale_mean</span>
        <span class="n">grad_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">target_mean</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale_mean</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Delta method variance</span>
        <span class="n">var_ratio</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">grad_target</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_target</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">grad_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_scale</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grad_target</span> <span class="o">*</span> <span class="n">grad_scale</span> <span class="o">*</span> <span class="n">cov_target_scale</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">var_ratio</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ratio_variance_cuped</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Y-only CUPED delta variance for the ratio of means on this group&#39;s rows.</span>
<span class="sd">        Uses pooled theta, but per-arm moments for the variance pieces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># data</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Code for n = 1 (deng et al)</span>
            <span class="n">Y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">scale</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">])</span>  <span class="c1"># 4</span>

            <span class="n">mu_Y</span><span class="p">,</span> <span class="n">mu_N</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="c1"># M is the same as N, in general it could be different,</span>
            <span class="c1"># but we&#39;re copying Deng et al. here and it&#39;s easier</span>
            <span class="n">mu_X</span><span class="p">,</span> <span class="n">mu_M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">M</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="c1"># the betas are from the deng paper</span>
            <span class="n">beta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu_N</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_Y</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">beta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu_M</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_X</span> <span class="o">/</span> <span class="n">mu_M</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

            <span class="n">var_Y_div_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">var_X_div_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>

            <span class="c1"># theta is a scalar in this case</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># can also use traditional delta method for the var_Y_div_N type terms</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">var_Y_div_N</span> <span class="o">+</span> <span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_X_div_M</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">cov</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">target</span>
            <span class="p">)</span>

        <span class="c1"># multiple covariates</span>
        <span class="n">variance_simple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;numerator&quot;</span><span class="p">]</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;denominator&quot;</span><span class="p">]</span>

        <span class="c1"># follow delta.md notation, but in general it&#39;s var(Y/N) + theta Var(X/M) theta^T - 2 theta cov(Y/N, X/M)</span>
        <span class="n">var_cuped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">variance_simple</span> <span class="o">+</span> <span class="p">(</span><span class="n">theta</span> <span class="o">@</span> <span class="n">denominator</span> <span class="o">@</span> <span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span> <span class="o">@</span> <span class="n">numerator</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">var_cuped</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_to_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an aggregated dataframe of the target and scale variables at the cluster (and treatment) level.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="n">aggregate_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">aggregate_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_correct_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
        <span class="n">covariates_means</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Corrects the target variable using thetas and covariates means.</span>
<span class="sd">        If thetas are not provided, it returns the original target.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">thetas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>

        <span class="c1"># Apply correction using thetas and covariates means</span>
        <span class="n">corrected_target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">covariate</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">mean</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">],</span> <span class="n">covariates_means</span>
        <span class="p">):</span>
            <span class="c1"># According to deng, covariate is supposed to be at the lower granularity level</span>
            <span class="c1"># so it predicts the ratio target/scale</span>
            <span class="n">corrected_target</span> <span class="o">-=</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">corrected_target</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ratio_variance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the variance of the ratio metric (target/scale) as estimated by the delta method.</span>
<span class="sd">        If covariates are given, variance reduction is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_cuped</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_group_mean_and_variance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
        <span class="n">covariates_means</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the mean and variance of the ratio metric (target/scale) as estimated by the delta method for a given group (treatment).</span>
<span class="sd">        If covariates are given, variance reduction is used. For it to work, the dataframe must be aggregated first at the cluster level, so no assumptions on aggregation of covariates has to be done.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corrected_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">covariates_means</span><span class="p">)</span>
        <span class="n">group_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corrected_target</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="n">group_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Return the mean and variance of the ratio metric</span>
        <span class="k">return</span> <span class="n">group_mean</span><span class="p">,</span> <span class="n">group_variance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_mean_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns mean and variance of the ratio metric (target/scale) for a given cluster (i.e. user) computed using the Delta Method.</span>
<span class="sd">        Variance reduction is used if covariates are given.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_num_clusters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters_warning_limit</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__warn_small_group_size</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__check_data_is_aggregated</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_to_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">is_treatment</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="n">thetas_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_thetas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">covariates_means</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">covariate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span>
        <span class="p">]</span>

        <span class="n">treat_mean</span><span class="p">,</span> <span class="n">treat_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_mean_and_variance</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">is_treatment</span><span class="p">],</span> <span class="n">thetas_dict</span><span class="p">,</span> <span class="n">covariates_means</span>
        <span class="p">)</span>
        <span class="n">ctrl_mean</span><span class="p">,</span> <span class="n">ctrl_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_mean_and_variance</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">is_treatment</span><span class="p">],</span> <span class="n">thetas_dict</span><span class="p">,</span> <span class="n">covariates_means</span>
        <span class="p">)</span>

        <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">treat_mean</span> <span class="o">-</span> <span class="n">ctrl_mean</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">treat_var</span> <span class="o">+</span> <span class="n">ctrl_var</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mean_diff</span><span class="p">,</span> <span class="n">standard_error</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the p-value of the analysis.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mean_diff</span><span class="p">,</span> <span class="n">standard_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">z_score</span> <span class="o">=</span> <span class="n">mean_diff</span> <span class="o">/</span> <span class="n">standard_error</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)))</span>

        <span class="n">results_delta</span> <span class="o">=</span> <span class="n">ModelResults</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">mean_diff</span><span class="p">},</span>
            <span class="n">pvalues</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">p_value</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_delta</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean_diff</span><span class="p">,</span> <span class="n">_standard_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mean_diff</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_mean_diff</span><span class="p">,</span> <span class="n">standard_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">standard_error</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ate</span><span class="p">,</span> <span class="n">std_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">z_score</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">/</span> <span class="n">std_error</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)))</span>

        <span class="n">results_delta</span> <span class="o">=</span> <span class="n">ModelResults</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">ate</span><span class="p">},</span>
            <span class="n">pvalues</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">p_value</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_delta</span><span class="p">)</span>

        <span class="c1"># Extract the confidence interval for the treatment column</span>
        <span class="n">crit_z_score</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">conf_int</span> <span class="o">=</span> <span class="n">crit_z_score</span> <span class="o">*</span> <span class="n">std_error</span>
        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">-</span> <span class="n">conf_int</span><span class="p">,</span> <span class="n">ate</span> <span class="o">+</span> <span class="n">conf_int</span>

        <span class="c1"># Return the confidence interval</span>
        <span class="k">return</span> <span class="n">ConfidenceInterval</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ate</span><span class="p">,</span> <span class="n">std_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">z_score</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">/</span> <span class="n">std_error</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)))</span>

        <span class="n">results_delta</span> <span class="o">=</span> <span class="n">ModelResults</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">ate</span><span class="p">},</span>
            <span class="n">pvalues</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">p_value</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_delta</span><span class="p">)</span>

        <span class="c1"># Extract the confidence interval for the treatment column</span>
        <span class="n">crit_z_score</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">conf_int</span> <span class="o">=</span> <span class="n">crit_z_score</span> <span class="o">*</span> <span class="n">std_error</span>
        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">-</span> <span class="n">conf_int</span><span class="p">,</span> <span class="n">ate</span> <span class="o">+</span> <span class="n">conf_int</span>

        <span class="c1"># Return the confidence interval</span>
        <span class="k">return</span> <span class="n">InferenceResults</span><span class="p">(</span>
            <span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span>
            <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
            <span class="n">std_error</span><span class="o">=</span><span class="n">std_error</span><span class="p">,</span>
            <span class="n">conf_int</span><span class="o">=</span><span class="n">ConfidenceInterval</span><span class="p">(</span>
                <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a DeltaMethodAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">scale_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">scale_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__check_data_is_aggregated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the data is already aggregated at the cluster level.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The data should be aggregated at the cluster level for the Delta Method analysis using covariates.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_num_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if there are enough clusters to run the analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__warn_small_group_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Delta Method approximation may not be accurate for small group sizes&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__check_data_is_aggregated" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__check_data_is_aggregated</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__check_data_is_aggregated" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Check if the data is already aggregated at the cluster level.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__check_data_is_aggregated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the data is already aggregated at the cluster level.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The data should be aggregated at the cluster level for the Delta Method analysis using covariates.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">cluster_cols</span><span class="p">,</span> <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">scale_col</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="n">treatment</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hypothesis</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Class to run the Delta Method approximation for estimating the treatment effect on a ratio metric (target/scale) under a clustered design.
The analysis is done on the aggregated data at the cluster level, making computation more efficient.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure (the numerator of the ratio).</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the scale variable (the denominator of the ratio).</p>
              </div>
            </td>
            <td>
                  <code>&#39;scale&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable.</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group.</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as covariates. Have to be previously aggregated at the cluster level.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis.</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Usage</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">scale_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span>
    <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
    <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
    <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run the Delta Method approximation for estimating the treatment effect on a ratio metric (target/scale) under a clustered design.</span>
<span class="sd">    The analysis is done on the aggregated data at the cluster level, making computation more efficient.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters.</span>
<span class="sd">        target_col: name of the column containing the variable to measure (the numerator of the ratio).</span>
<span class="sd">        scale_col: name of the column containing the scale variable (the denominator of the ratio).</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable.</span>
<span class="sd">        treatment: name of the treatment to use as the treated group.</span>
<span class="sd">        covariates: list of columns to use as covariates. Have to be previously aggregated at the cluster level.</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis.</span>

<span class="sd">        Usage:</span>
<span class="sd">        ```python</span>
<span class="sd">        import pandas as pd</span>

<span class="sd">        from cluster_experiments.experiment_analysis import DeltaMethodAnalysis</span>

<span class="sd">        df = pd.DataFrame({</span>
<span class="sd">            &#39;x&#39;: [1, 2, 3, 0, 0, 1] * 2,</span>
<span class="sd">            &#39;y&#39;: [2, 2, 5, 1, 1, 1] * 2,</span>
<span class="sd">            &#39;treatment&#39;: [&quot;A&quot;] * 6 + [&quot;B&quot;] * 6,</span>
<span class="sd">            &#39;cluster&#39;: [1, 2, 3, 1, 2, 3] * 2,</span>
<span class="sd">            &#39;z&#39;: [1, 2, 3, 4, 5, 6] * 2,</span>
<span class="sd">        })</span>

<span class="sd">        DeltaMethodAnalysis(</span>
<span class="sd">            cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">            target_col=&#39;x&#39;,</span>
<span class="sd">            scale_col=&#39;y&#39;,</span>
<span class="sd">            covariates=[&#39;z&#39;]</span>
<span class="sd">        ).get_pvalue(df)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="o">=</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span> <span class="o">=</span> <span class="n">scale_col</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="n">cluster_cols</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span> <span class="ow">or</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._aggregate_to_cluster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_aggregate_to_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._aggregate_to_cluster" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns an aggregated dataframe of the target and scale variables at the cluster (and treatment) level.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_to_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an aggregated dataframe of the target and scale variables at the cluster (and treatment) level.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="n">aggregate_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">aggregate_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._compute_thetas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_compute_thetas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._compute_thetas" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Computes the theta value for the CUPED method.
Thetas are computed as the inverse of the covariance matrix of covariates multiplied by the covariance between covariates and target metric.</p>
<p>Delta method with CUPED should work like the following. For each randomization unit i we observe $Y_i$, $N_i$.</p>
<p>Refer to delta.md for mathematical details.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_compute_thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the theta value for the CUPED method.</span>
<span class="sd">    Thetas are computed as the inverse of the covariance matrix of covariates multiplied by the covariance between covariates and target metric.</span>

<span class="sd">    Delta method with CUPED should work like the following. For each randomization unit i we observe $Y_i$, $N_i$.</span>

<span class="sd">    Refer to delta.md for mathematical details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">])</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">])</span>
    <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Code for n = 1 (deng et al)</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">scale</span>

        <span class="c1"># need to covariate * scale to get X_i = covariate_i * N_i</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">])</span>  <span class="c1"># 4</span>

        <span class="n">mu_Y</span><span class="p">,</span> <span class="n">mu_N</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">mu_X</span><span class="p">,</span> <span class="n">mu_M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">M</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu_N</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_Y</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu_M</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_X</span> <span class="o">/</span> <span class="n">mu_M</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># formula from Deng et al. n&#39;s would cancel out</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="n">beta2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">theta</span><span class="p">])}</span>

    <span class="c1"># Sample means</span>
    <span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">covariates</span> <span class="o">*</span> <span class="n">scale</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">]),</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">mu_Y</span><span class="p">,</span> <span class="n">mu_N</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mu_X</span><span class="p">,</span> <span class="n">mu_M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span>

    <span class="c1"># numerator (follow delta.md)</span>
    <span class="n">cov_YX</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">cov_NX</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">cov_YN</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cov_NN</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">cov_YX</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span>
        <span class="o">-</span> <span class="p">(</span><span class="n">mu_Y</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov_NX</span> <span class="o">/</span> <span class="n">mu_N</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">mu_X</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov_YN</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">mu_X</span> <span class="o">*</span> <span class="n">mu_Y</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov_NN</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># denominator (follow delta.md, K * D * K^T)</span>
    <span class="n">d_matrix</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="mi">2</span><span class="p">:]</span>  <span class="c1"># (k + 1) x (k + 1)</span>
    <span class="n">k_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">k_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu_M</span>
    <span class="n">k_matrix</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu_X</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu_M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">k_matrix</span> <span class="o">@</span> <span class="n">d_matrix</span> <span class="o">@</span> <span class="n">k_matrix</span><span class="o">.</span><span class="n">T</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">denominator</span><span class="p">),</span> <span class="n">numerator</span><span class="p">)</span>
    <span class="c1"># return both theta and pieces for variance calculation</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s2">&quot;numerator&quot;</span><span class="p">:</span> <span class="n">numerator</span><span class="p">,</span> <span class="s2">&quot;denominator&quot;</span><span class="p">:</span> <span class="n">denominator</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._correct_target" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_correct_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">covariates_means</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._correct_target" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Corrects the target variable using thetas and covariates means.
If thetas are not provided, it returns the original target.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_correct_target</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="n">covariates_means</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Corrects the target variable using thetas and covariates means.</span>
<span class="sd">    If thetas are not provided, it returns the original target.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">thetas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>

    <span class="c1"># Apply correction using thetas and covariates means</span>
    <span class="n">corrected_target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">covariate</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">mean</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">],</span> <span class="n">covariates_means</span>
    <span class="p">):</span>
        <span class="c1"># According to deng, covariate is supposed to be at the lower granularity level</span>
        <span class="c1"># so it predicts the ratio target/scale</span>
        <span class="n">corrected_target</span> <span class="o">-=</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">corrected_target</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_group_mean_and_variance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_group_mean_and_variance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">covariates_means</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_group_mean_and_variance" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the mean and variance of the ratio metric (target/scale) as estimated by the delta method for a given group (treatment).
If covariates are given, variance reduction is used. For it to work, the dataframe must be aggregated first at the cluster level, so no assumptions on aggregation of covariates has to be done.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_group_mean_and_variance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="n">covariates_means</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the mean and variance of the ratio metric (target/scale) as estimated by the delta method for a given group (treatment).</span>
<span class="sd">    If covariates are given, variance reduction is used. For it to work, the dataframe must be aggregated first at the cluster level, so no assumptions on aggregation of covariates has to be done.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">corrected_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">covariates_means</span><span class="p">)</span>
    <span class="n">group_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">corrected_target</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
        <span class="n">group_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Return the mean and variance of the ratio metric</span>
    <span class="k">return</span> <span class="n">group_mean</span><span class="p">,</span> <span class="n">group_variance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_mean_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_mean_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns mean and variance of the ratio metric (target/scale) for a given cluster (i.e. user) computed using the Delta Method.
Variance reduction is used if covariates are given.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_mean_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns mean and variance of the ratio metric (target/scale) for a given cluster (i.e. user) computed using the Delta Method.</span>
<span class="sd">    Variance reduction is used if covariates are given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_num_clusters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters_warning_limit</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__warn_small_group_size</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_data_is_aggregated</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_to_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">is_treatment</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">thetas_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_thetas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">covariates_means</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">covariate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span>
    <span class="p">]</span>

    <span class="n">treat_mean</span><span class="p">,</span> <span class="n">treat_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_mean_and_variance</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">is_treatment</span><span class="p">],</span> <span class="n">thetas_dict</span><span class="p">,</span> <span class="n">covariates_means</span>
    <span class="p">)</span>
    <span class="n">ctrl_mean</span><span class="p">,</span> <span class="n">ctrl_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_mean_and_variance</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">is_treatment</span><span class="p">],</span> <span class="n">thetas_dict</span><span class="p">,</span> <span class="n">covariates_means</span>
    <span class="p">)</span>

    <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">treat_mean</span> <span class="o">-</span> <span class="n">ctrl_mean</span>
    <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">treat_var</span> <span class="o">+</span> <span class="n">ctrl_var</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_diff</span><span class="p">,</span> <span class="n">standard_error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_num_clusters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_num_clusters</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_num_clusters" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Check if there are enough clusters to run the analysis.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_num_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if there are enough clusters to run the analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_ratio_variance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the variance of the ratio metric (target/scale) as estimated by the delta method.
If covariates are given, variance reduction is used.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_ratio_variance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the variance of the ratio metric (target/scale) as estimated by the delta method.</span>
<span class="sd">    If covariates are given, variance reduction is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_cuped</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_cuped" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_ratio_variance_cuped</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_cuped" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Y-only CUPED delta variance for the ratio of means on this group's rows.
Uses pooled theta, but per-arm moments for the variance pieces.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_ratio_variance_cuped</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">thetas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Y-only CUPED delta variance for the ratio of means on this group&#39;s rows.</span>
<span class="sd">    Uses pooled theta, but per-arm moments for the variance pieces.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># data</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Code for n = 1 (deng et al)</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">scale</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">([</span><span class="n">Y</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">])</span>  <span class="c1"># 4</span>

        <span class="n">mu_Y</span><span class="p">,</span> <span class="n">mu_N</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># M is the same as N, in general it could be different,</span>
        <span class="c1"># but we&#39;re copying Deng et al. here and it&#39;s easier</span>
        <span class="n">mu_X</span><span class="p">,</span> <span class="n">mu_M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">M</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># the betas are from the deng paper</span>
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu_N</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_Y</span> <span class="o">/</span> <span class="n">mu_N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mu_M</span><span class="p">,</span> <span class="o">-</span><span class="n">mu_X</span> <span class="o">/</span> <span class="n">mu_M</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">var_Y_div_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">var_X_div_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>

        <span class="c1"># theta is a scalar in this case</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># can also use traditional delta method for the var_Y_div_N type terms</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">var_Y_div_N</span> <span class="o">+</span> <span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_X_div_M</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">cov</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">target</span>
        <span class="p">)</span>

    <span class="c1"># multiple covariates</span>
    <span class="n">variance_simple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;numerator&quot;</span><span class="p">]</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="s2">&quot;denominator&quot;</span><span class="p">]</span>

    <span class="c1"># follow delta.md notation, but in general it&#39;s var(Y/N) + theta Var(X/M) theta^T - 2 theta cov(Y/N, X/M)</span>
    <span class="n">var_cuped</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">variance_simple</span> <span class="o">+</span> <span class="p">(</span><span class="n">theta</span> <span class="o">@</span> <span class="n">denominator</span> <span class="o">@</span> <span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span> <span class="o">@</span> <span class="n">numerator</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">var_cuped</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_ratio_variance_simple</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Variance of the ratio of means (sum(target)/sum(scale)) via delta method.</p>
<h5 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--parameters">Parameters<a class="headerlink" href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--parameters" title="Permanent link">&para;</a></h5>
<p>target : array-like
    Numerator per unit.
scale : array-like
    Denominator per unit.</p>
<h5 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--returns">Returns<a class="headerlink" href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis._get_ratio_variance_simple--returns" title="Permanent link">&para;</a></h5>
<p>variance : float
    Estimated variance of the ratio metric.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_ratio_variance_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variance of the ratio of means (sum(target)/sum(scale)) via delta method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target : array-like</span>
<span class="sd">        Numerator per unit.</span>
<span class="sd">    scale : array-like</span>
<span class="sd">        Denominator per unit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    variance : float</span>
<span class="sd">        Estimated variance of the ratio metric.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">])</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_col</span><span class="p">])</span>

    <span class="n">target_mean</span><span class="p">,</span> <span class="n">scale_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

    <span class="c1"># Sample variances and covariance</span>
    <span class="n">var_target</span><span class="p">,</span> <span class="n">var_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cov_target_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Gradient of g(Ȳ, scalē) = Ȳ / scalē</span>
    <span class="n">grad_target</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">scale_mean</span>
    <span class="n">grad_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">target_mean</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale_mean</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Delta method variance</span>
    <span class="n">var_ratio</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">grad_target</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_target</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">grad_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_scale</span>
        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grad_target</span> <span class="o">*</span> <span class="n">grad_scale</span> <span class="o">*</span> <span class="n">cov_target_scale</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">var_ratio</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_confidence_interval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_confidence_interval" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the confidence interval of the analysis
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ate</span><span class="p">,</span> <span class="n">std_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">z_score</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">/</span> <span class="n">std_error</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)))</span>

    <span class="n">results_delta</span> <span class="o">=</span> <span class="n">ModelResults</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">ate</span><span class="p">},</span>
        <span class="n">pvalues</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">p_value</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_delta</span><span class="p">)</span>

    <span class="c1"># Extract the confidence interval for the treatment column</span>
    <span class="n">crit_z_score</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">conf_int</span> <span class="o">=</span> <span class="n">crit_z_score</span> <span class="o">*</span> <span class="n">std_error</span>
    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">-</span> <span class="n">conf_int</span><span class="p">,</span> <span class="n">ate</span> <span class="o">+</span> <span class="n">conf_int</span>

    <span class="c1"># Return the confidence interval</span>
    <span class="k">return</span> <span class="n">ConfidenceInterval</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_inference_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_inference_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the inference results of the analysis
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ate</span><span class="p">,</span> <span class="n">std_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">z_score</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">/</span> <span class="n">std_error</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)))</span>

    <span class="n">results_delta</span> <span class="o">=</span> <span class="n">ModelResults</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">ate</span><span class="p">},</span>
        <span class="n">pvalues</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">p_value</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_delta</span><span class="p">)</span>

    <span class="c1"># Extract the confidence interval for the treatment column</span>
    <span class="n">crit_z_score</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">conf_int</span> <span class="o">=</span> <span class="n">crit_z_score</span> <span class="o">*</span> <span class="n">std_error</span>
    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">ate</span> <span class="o">-</span> <span class="n">conf_int</span><span class="p">,</span> <span class="n">ate</span> <span class="o">+</span> <span class="n">conf_int</span>

    <span class="c1"># Return the confidence interval</span>
    <span class="k">return</span> <span class="n">InferenceResults</span><span class="p">(</span>
        <span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span>
        <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
        <span class="n">std_error</span><span class="o">=</span><span class="n">std_error</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="n">ConfidenceInterval</span><span class="p">(</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the point estimate of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_diff</span><span class="p">,</span> <span class="n">_standard_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean_diff</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the p-value of the analysis.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mean_diff</span><span class="p">,</span> <span class="n">standard_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">z_score</span> <span class="o">=</span> <span class="n">mean_diff</span> <span class="o">/</span> <span class="n">standard_error</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)))</span>

    <span class="n">results_delta</span> <span class="o">=</span> <span class="n">ModelResults</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">mean_diff</span><span class="p">},</span>
        <span class="n">pvalues</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">:</span> <span class="n">p_value</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_delta</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p_value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.analysis_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the standard error of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_mean_diff</span><span class="p">,</span> <span class="n">standard_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">standard_error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.DeltaMethodAnalysis.from_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.DeltaMethodAnalysis.from_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Creates a DeltaMethodAnalysis object from a PowerConfig object</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a DeltaMethodAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">scale_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">scale_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.ExperimentAnalysis" class="doc doc-heading">
            <code>ExperimentAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract class to run the analysis of a given experiment</p>
<p>In order to create your own ExperimentAnalysis,
you should create a derived class that implements the analysis_pvalue method.</p>
<p>It can also be used as a component of the PowerAnalysis class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as covariates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ExperimentAnalysis</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class to run the analysis of a given experiment</span>

<span class="sd">    In order to create your own ExperimentAnalysis,</span>
<span class="sd">    you should create a derived class that implements the analysis_pvalue method.</span>

<span class="sd">    It can also be used as a component of the PowerAnalysis class.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        covariates: list of columns to use as covariates</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_col</span> <span class="o">=</span> <span class="n">target_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment</span> <span class="o">=</span> <span class="n">treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span> <span class="o">=</span> <span class="n">treatment_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="n">cluster_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span> <span class="o">=</span> <span class="n">hypothesis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span> <span class="o">=</span> <span class="n">add_covariate_interaction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cluster_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Paste all strings of cluster_cols in one single column&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_binary_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transforms treatment column into 0 - 1 column&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_interaction_covariates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each covariate, adds a column with treatment * (x - mean(x))</span>
<span class="sd">        This is used to build a more efficient estimator of the ATE</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>
<span class="sd">            df (pd.DataFrame): input data frame</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            pd.DataFrame: data frame with additional columns</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">for</span> <span class="n">covariate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">covariate</span><span class="si">}</span><span class="s2">__interaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># simple case, no covariates</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="si">}</span><span class="s2"> ~ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
            <span class="c1"># second case: covariates but not interaction</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="si">}</span><span class="s2"> ~ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># third case: covariates and interaction</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="si">}</span><span class="s2"> ~ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">)</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;__</span><span class="si">{</span><span class="n">covariate</span><span class="si">}</span><span class="s1">__interaction&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">covariate</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the p-value of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the point estimate of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Point estimate not implemented for this analysis&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the standard error of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Standard error not implemented for this analysis&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the confidence interval of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Confidence Interval not implemented for this analysis&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the InferenceResults object of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Inference results are not implemented for this analysis&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_data_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks that the data is correct&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There are null values in outcome column </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Outcome column </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="si">}</span><span class="s2"> should be numeric and not </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_confidence_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_inference_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pvalue_based_on_hypothesis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_result</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># todo add typehint statsmodels result</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            model_result: statsmodels result object</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">treatment_effect</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">LESS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">treatment_effect</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">GREATER</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">treatment_effect</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">TWO_SIDED</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p_value</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="si">}</span><span class="s2"> is not a valid HypothesisEntries&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_split_pre_experiment_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;This method should be implemented in the child class&quot;</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an ExperimentAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>For each covariate, adds a column with treatment * (x - mean(x))
This is used to build a more efficient estimator of the ATE</p>
<h5 id="cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--args">Args<a class="headerlink" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--args" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>df (pd.DataFrame): input data frame
</code></pre></div>

<h5 id="cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--returns">Returns<a class="headerlink" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._add_interaction_covariates--returns" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code>pd.DataFrame: data frame with additional columns
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_add_interaction_covariates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For each covariate, adds a column with treatment * (x - mean(x))</span>
<span class="sd">    This is used to build a more efficient estimator of the ATE</span>

<span class="sd">    Args</span>
<span class="sd">    ----</span>
<span class="sd">        df (pd.DataFrame): input data frame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        pd.DataFrame: data frame with additional columns</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">for</span> <span class="n">covariate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">covariate</span><span class="si">}</span><span class="s2">__interaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">covariate</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis._create_binary_treatment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._create_binary_treatment" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Transforms treatment column into 0 - 1 column</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_create_binary_treatment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transforms treatment column into 0 - 1 column&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis._data_checks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._data_checks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Checks that the data is correct</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_data_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks that the data is correct&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There are null values in outcome column </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Outcome column </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="si">}</span><span class="s2"> should be numeric and not </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis._get_cluster_column" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis._get_cluster_column" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Paste all strings of cluster_cols in one single column</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_cluster_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Paste all strings of cluster_cols in one single column&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_confidence_interval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_confidence_interval" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the confidence interval of the analysis. Expects treatment to be 0-1 variable
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the confidence interval of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;Confidence Interval not implemented for this analysis&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_inference_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_inference_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the InferenceResults object of the analysis. Expects treatment to be 0-1 variable
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the InferenceResults object of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;Inference results are not implemented for this analysis&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the point estimate of the analysis. Expects treatment to be 0-1 variable
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the point estimate of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Point estimate not implemented for this analysis&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis. Expects treatment to be 0-1 variable
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the p-value of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.analysis_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the standard error of the analysis. Expects treatment to be 0-1 variable
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the standard error of the analysis. Expects treatment to be 0-1 variable</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Standard error not implemented for this analysis&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.from_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.from_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Creates an ExperimentAnalysis object from a PowerConfig object</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates an ExperimentAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.get_confidence_interval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_confidence_interval" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the confidence interval of the analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>significance level</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_confidence_interval</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.get_inference_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_inference_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the inference results of the analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>significance level</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_inference_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.get_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the point estimate of the analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.get_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.get_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.get_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the standard error of the analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing the data to analyze</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_binary_treatment</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data_checks</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.ExperimentAnalysis.pvalue_based_on_hypothesis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">model_result</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.ExperimentAnalysis.pvalue_based_on_hypothesis" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis
Arguments:
    model_result: statsmodels result object
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pvalue_based_on_hypothesis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">model_result</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># todo add typehint statsmodels result</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        model_result: statsmodels result object</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">treatment_effect</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">LESS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">treatment_effect</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">GREATER</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">treatment_effect</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_value</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">TWO_SIDED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p_value</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="si">}</span><span class="s2"> is not a valid HypothesisEntries&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis" class="doc doc-heading">
            <code>GeeExperimentAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>


        <p>Class to run GEE clustered analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as covariates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeeExperimentAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">GeeExperimentAnalysis</span><span class="p">(</span>
    <span class="n">cluster_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GeeExperimentAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run GEE clustered analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        covariates: list of columns to use as covariates</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import GeeExperimentAnalysis</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    df = pd.DataFrame({</span>
<span class="sd">        &#39;x&#39;: [1, 2, 3, 0, 0, 1],</span>
<span class="sd">        &#39;treatment&#39;: [&quot;A&quot;] * 3 + [&quot;B&quot;] * 3,</span>
<span class="sd">        &#39;cluster&#39;: [1] * 6,</span>
<span class="sd">    })</span>

<span class="sd">    GeeExperimentAnalysis(</span>
<span class="sd">        cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">        target_col=&#39;x&#39;,</span>
<span class="sd">    ).get_pvalue(df)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fam</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">Exchangeable</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_gee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">GEE</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the fitted GEE model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">GEE</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="n">family</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fam</span><span class="p">,</span>
            <span class="n">cov_struct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">va</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_gee</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_gee</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># Extract the confidence interval for the treatment column</span>
        <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_gee</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="c1"># Return the confidence interval</span>
        <span class="k">return</span> <span class="n">ConfidenceInterval</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">std_error</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="n">ate</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_gee</span><span class="p">)</span>

        <span class="c1"># Extract the confidence interval for the treatment column</span>
        <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_gee</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="c1"># Return the confidence interval</span>
        <span class="k">return</span> <span class="n">InferenceResults</span><span class="p">(</span>
            <span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span>
            <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
            <span class="n">std_error</span><span class="o">=</span><span class="n">std_error</span><span class="p">,</span>
            <span class="n">conf_int</span><span class="o">=</span><span class="n">ConfidenceInterval</span><span class="p">(</span>
                <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
            <span class="p">),</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_confidence_interval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_confidence_interval" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the confidence interval of the analysis
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># Extract the confidence interval for the treatment column</span>
    <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_gee</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Return the confidence interval</span>
    <span class="k">return</span> <span class="n">ConfidenceInterval</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_inference_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_inference_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the inference results of the analysis
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">std_error</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="n">ate</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_gee</span><span class="p">)</span>

    <span class="c1"># Extract the confidence interval for the treatment column</span>
    <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_gee</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Return the confidence interval</span>
    <span class="k">return</span> <span class="n">InferenceResults</span><span class="p">(</span>
        <span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span>
        <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
        <span class="n">std_error</span><span class="o">=</span><span class="n">std_error</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="n">ConfidenceInterval</span><span class="p">(</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the point estimate of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_gee</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_gee</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.analysis_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the standard error of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_gee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_gee</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.GeeExperimentAnalysis.fit_gee" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_gee</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.GeeExperimentAnalysis.fit_gee" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the fitted GEE model</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_gee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">GEE</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the fitted GEE model&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">GEE</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="n">family</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fam</span><span class="p">,</span>
        <span class="n">cov_struct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">va</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.InferenceResults" class="doc doc-heading">
            <code>InferenceResults</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.InferenceResults" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Class to define the structure of complete statistical analysis results.</p>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">InferenceResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to define the structure of complete statistical analysis results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ate</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">p_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">std_error</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">conf_int</span><span class="p">:</span> <span class="n">ConfidenceInterval</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.MLMExperimentAnalysis" class="doc doc-heading">
            <code>MLMExperimentAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>


        <p>Class to run Mixed Linear Models clustered analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as covariates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLMExperimentAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">MLMExperimentAnalysis</span><span class="p">(</span>
    <span class="n">cluster_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MLMExperimentAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run Mixed Linear Models clustered analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        covariates: list of columns to use as covariates</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import MLMExperimentAnalysis</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    df = pd.DataFrame({</span>
<span class="sd">        &#39;x&#39;: [1, 2, 3, 0, 0, 1],</span>
<span class="sd">        &#39;treatment&#39;: [&quot;A&quot;] * 3 + [&quot;B&quot;] * 3,</span>
<span class="sd">        &#39;cluster&#39;: [1] * 6,</span>
<span class="sd">    })</span>

<span class="sd">    MLMExperimentAnalysis(</span>
<span class="sd">        cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">        target_col=&#39;x&#39;,</span>
<span class="sd">    ).get_pvalue(df)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_formula</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vc_formula</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_mlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the fitted MLM model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
            <span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="n">re_formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_formula</span><span class="p">,</span>
            <span class="n">vc_formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vc_formula</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_mlm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_mlm</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_mlm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_mlm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_mlm</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_mlm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_mlm</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the point estimate of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_mlm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_mlm</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_mlm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_mlm</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_mlm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.analysis_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the standard error of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_mlm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_mlm</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.MLMExperimentAnalysis.fit_mlm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_mlm</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.MLMExperimentAnalysis.fit_mlm" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the fitted MLM model</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_mlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the fitted MLM model&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
        <span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="n">re_formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_formula</span><span class="p">,</span>
        <span class="n">vc_formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vc_formula</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.OLSAnalysis" class="doc doc-heading">
            <code>OLSAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.OLSAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>


        <p>Class to run OLS analysis</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>covariates</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as covariates</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cov_type</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Literal">Literal</span>[&#39;nonrobust&#39;, &#39;fixed scale&#39;, &#39;HC0&#39;, &#39;HC1&#39;, &#39;HC2&#39;, &#39;HC3&#39;, &#39;HAC&#39;, &#39;hac-panel&#39;, &#39;hac-groupsum&#39;, &#39;cluster&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "nonrobust", "fixed scale", "HC0", "HC1", "HC2", "HC3", "HAC", "hac-panel", "hac-groupsum", "cluster"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">OLSAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">OLSAnalysis</span><span class="p">(</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OLSAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run OLS analysis</span>

<span class="sd">    Arguments:</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        covariates: list of columns to use as covariates</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>
<span class="sd">        cov_type: one of &quot;nonrobust&quot;, &quot;fixed scale&quot;, &quot;HC0&quot;, &quot;HC1&quot;, &quot;HC2&quot;, &quot;HC3&quot;, &quot;HAC&quot;, &quot;hac-panel&quot;, &quot;hac-groupsum&quot;, &quot;cluster&quot;</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import OLSAnalysis</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    df = pd.DataFrame({</span>
<span class="sd">        &#39;x&#39;: [1, 2, 3, 0, 0, 1],</span>
<span class="sd">        &#39;treatment&#39;: [&quot;A&quot;] * 3 + [&quot;B&quot;] * 3,</span>
<span class="sd">    })</span>

<span class="sd">    OLSAnalysis(</span>
<span class="sd">        target_col=&#39;x&#39;,</span>
<span class="sd">    ).get_pvalue(df)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
        <span class="n">cov_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Literal</span><span class="p">[</span>
                <span class="s2">&quot;nonrobust&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fixed scale&quot;</span><span class="p">,</span>
                <span class="s2">&quot;HC0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;HC1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;HC2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;HC3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;HAC&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hac-panel&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hac-groupsum&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_col</span> <span class="o">=</span> <span class="n">target_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment</span> <span class="o">=</span> <span class="n">treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span> <span class="o">=</span> <span class="n">treatment_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span> <span class="o">=</span> <span class="n">hypothesis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;nonrobust&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fixed scale&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HC0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HC1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HC2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HC3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HAC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hac-panel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hac-groupsum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;HC3&quot;</span> <span class="k">if</span> <span class="n">cov_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cov_type</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span> <span class="o">=</span> <span class="n">add_covariate_interaction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_ols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the fitted OLS model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_ols</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_ols</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># Extract the confidence interval for the treatment column</span>
        <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_ols</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="c1"># Return the confidence interval</span>
        <span class="k">return</span> <span class="n">ConfidenceInterval</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            alpha: significance level</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">std_error</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="n">ate</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_ols</span><span class="p">)</span>

        <span class="c1"># Extract the confidence interval for the treatment column</span>
        <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results_ols</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="c1"># Return the confidence interval</span>
        <span class="k">return</span> <span class="n">InferenceResults</span><span class="p">(</span>
            <span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span>
            <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
            <span class="n">std_error</span><span class="o">=</span><span class="n">std_error</span><span class="p">,</span>
            <span class="n">conf_int</span><span class="o">=</span><span class="n">ConfidenceInterval</span><span class="p">(</span>
                <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an OLSAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">cov_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cov_type</span><span class="p">,</span>
            <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.analysis_confidence_interval" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_confidence_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_confidence_interval" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the confidence interval of the analysis
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_confidence_interval</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConfidenceInterval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the confidence interval of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># Extract the confidence interval for the treatment column</span>
    <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_ols</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Return the confidence interval</span>
    <span class="k">return</span> <span class="n">ConfidenceInterval</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.analysis_inference_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_inference_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_inference_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the inference results of the analysis
Arguments:
    df: dataframe containing the data to analyze
    alpha: significance level
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_inference_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferenceResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the inference results of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        alpha: significance level</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">std_error</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="n">ate</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_ols</span><span class="p">)</span>

    <span class="c1"># Extract the confidence interval for the treatment column</span>
    <span class="n">conf_int_df</span> <span class="o">=</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">conf_int_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_ols</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="c1"># Return the confidence interval</span>
    <span class="k">return</span> <span class="n">InferenceResults</span><span class="p">(</span>
        <span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span>
        <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
        <span class="n">std_error</span><span class="o">=</span><span class="n">std_error</span><span class="p">,</span>
        <span class="n">conf_int</span><span class="o">=</span><span class="n">ConfidenceInterval</span><span class="p">(</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.analysis_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the point estimate of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the point estimate of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_ols</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

    <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">results_ols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.analysis_standard_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_standard_error</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.analysis_standard_error" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the standard error of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the standard error of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_ols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_ols</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.fit_ols" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_ols</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.fit_ols" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the fitted OLS model</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_ols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the fitted OLS model&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_interaction_covariates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.OLSAnalysis.from_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.OLSAnalysis.from_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Creates an OLSAnalysis object from a PowerConfig object</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates an OLSAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">covariates</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">covariates</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="n">cov_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cov_type</span><span class="p">,</span>
        <span class="n">add_covariate_interaction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_covariate_interaction</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis" class="doc doc-heading">
            <code>PairedTTestClusteredAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>


        <p>Class to run paired T-test analysis on aggregated data</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strata_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of index columns for paired t test. Should be a subset or equal to cluster_cols</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">PairedTTestClusteredAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
<span class="p">})</span>

<span class="n">PairedTTestClusteredAnalysis</span><span class="p">(</span>
    <span class="n">cluster_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
    <span class="n">strata_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PairedTTestClusteredAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run paired T-test analysis on aggregated data</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        strata_cols: list of index columns for paired t test. Should be a subset or equal to cluster_cols</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import PairedTTestClusteredAnalysis</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    df = pd.DataFrame({</span>
<span class="sd">        &#39;x&#39;: [1, 2, 3, 4, 0, 0, 1, 1],</span>
<span class="sd">        &#39;treatment&#39;: [&quot;A&quot;, &quot;B&quot;, &quot;A&quot;, &quot;B&quot;] * 2,</span>
<span class="sd">        &#39;cluster&#39;: [1, 2, 3, 4, 1, 2, 3, 4],</span>
<span class="sd">    })</span>

<span class="sd">    PairedTTestClusteredAnalysis(</span>
<span class="sd">        cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">        strata_cols=[&#39;cluster&#39;],</span>
<span class="sd">        target_col=&#39;x&#39;,</span>
<span class="sd">    ).get_pvalue(df)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">strata_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strata_cols</span> <span class="o">=</span> <span class="n">strata_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_col</span> <span class="o">=</span> <span class="n">target_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment</span> <span class="o">=</span> <span class="n">treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span> <span class="o">=</span> <span class="n">treatment_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="n">cluster_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span> <span class="o">=</span> <span class="n">hypothesis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df_grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">n_control</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_treatment</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">n_control</span> <span class="o">!=</span> <span class="n">n_treatment</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;groups don&#39;t have same number of observations, </span><span class="si">{</span><span class="n">n_treatment</span><span class="w"> </span><span class="si">=}</span><span class="s2"> and  </span><span class="si">{</span><span class="n">n_control</span><span class="w"> </span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strata_cols</span><span class="p">]</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;strata should be a subset or equal to cluster_cols (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="w"> </span><span class="si">= }</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strata_cols</span><span class="w"> </span><span class="si">= }</span><span class="s2">)&quot;</span>

        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strata_cols</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There are missing pairs for some clusters, removing the lonely ones: </span><span class="si">{</span><span class="n">df_pivot</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;performing paired t test in this data </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">df_pivot</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df_pivot</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the extra info if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
        <span class="p">),</span> <span class="s2">&quot;cluster_cols needs to be a list of strings (even with one element)&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strata_cols</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
        <span class="p">),</span> <span class="s2">&quot;strata_cols needs to be a list of strings (even with one element)&quot;</span>

        <span class="n">df_pivot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessing</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

        <span class="n">t_test_results</span> <span class="o">=</span> <span class="n">ttest_rel</span><span class="p">(</span>
            <span class="n">df_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alternative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paired t test results: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">t_test_results</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t_test_results</span><span class="o">.</span><span class="n">pvalue</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a PairedTTestClusteredAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">strata_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">strata_cols</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the extra info if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the extra info if True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="p">),</span> <span class="s2">&quot;cluster_cols needs to be a list of strings (even with one element)&quot;</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strata_cols</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="p">),</span> <span class="s2">&quot;strata_cols needs to be a list of strings (even with one element)&quot;</span>

    <span class="n">df_pivot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessing</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

    <span class="n">t_test_results</span> <span class="o">=</span> <span class="n">ttest_rel</span><span class="p">(</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alternative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paired t test results: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">t_test_results</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t_test_results</span><span class="o">.</span><span class="n">pvalue</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.from_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.PairedTTestClusteredAnalysis.from_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Creates a PairedTTestClusteredAnalysis object from a PowerConfig object</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a PairedTTestClusteredAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">strata_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">strata_cols</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis" class="doc doc-heading">
            <code>SyntheticControlAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>


        <p>Class to run Synthetic control analysis. It expects only one treatment cluster.</p>
<p>Arguments:</p>
<div class="codehilite"><pre><span></span><code><span class="n">target_col</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="p">):</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">measure</span><span class="o">.</span>
<span class="n">treatment_col</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="p">):</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">treatment</span><span class="w"> </span><span class="n">variable</span><span class="o">.</span>
<span class="n">treatment</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="p">):</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">treatment</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">treated</span><span class="w"> </span><span class="n">group</span><span class="o">.</span>
<span class="n">cluster_cols</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="p">):</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">clusters</span><span class="o">.</span>
<span class="n">hypothesis</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="p">):</span><span class="w"> </span><span class="n">One</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="s2">&quot;two-sided&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;less&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;greater&quot;</span><span class="w"> </span><span class="n">indicating</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">hypothesis</span><span class="o">.</span>
<span class="n">time_col</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="p">):</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">data</span><span class="o">.</span>
<span class="n">intervention_date</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="p">):</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">intervention</span><span class="w"> </span><span class="n">occurred</span><span class="o">.</span>
</code></pre></div>

<p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">SyntheticControlAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">&quot;2022-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2022-01-31&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>

<span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

<span class="c1"># Create a combination of each date with each user</span>
<span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">dates</span><span class="p">))</span>

<span class="n">target_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">))</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">combinations</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_values</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;User 5&quot;</span><span class="p">),</span> <span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span>

<span class="n">SyntheticControlAnalysis</span><span class="p">(</span>
    <span class="n">cluster_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">intervention_date</span><span class="o">=</span><span class="s2">&quot;2022-01-15&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SyntheticControlAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run Synthetic control analysis. It expects only one treatment cluster.</span>

<span class="sd">    Arguments:</span>

<span class="sd">        target_col (str): The name of the column containing the variable to measure.</span>
<span class="sd">        treatment_col (str): The name of the column containing the treatment variable.</span>
<span class="sd">        treatment (str): The name of the treatment to use as the treated group.</span>
<span class="sd">        cluster_cols (list): A list of columns to use as clusters.</span>
<span class="sd">        hypothesis (str): One of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the hypothesis.</span>
<span class="sd">        time_col (str): The name of the column containing the time data.</span>
<span class="sd">        intervention_date (str): The date when the intervention occurred.</span>
<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import SyntheticControlAnalysis</span>
<span class="sd">    import pandas as pd</span>
<span class="sd">    import numpy as np</span>
<span class="sd">    from itertools import product</span>

<span class="sd">    dates = pd.date_range(&quot;2022-01-01&quot;, &quot;2022-01-31&quot;, freq=&quot;d&quot;)</span>

<span class="sd">    users = [f&quot;User {i}&quot; for i in range(10)]</span>

<span class="sd">    # Create a combination of each date with each user</span>
<span class="sd">    combinations = list(product(users, dates))</span>

<span class="sd">    target_values = np.random.normal(0, 1, size=len(combinations))</span>

<span class="sd">    df = pd.DataFrame(combinations, columns=[&quot;user&quot;, &quot;date&quot;])</span>
<span class="sd">    df[&quot;target&quot;] = target_values</span>

<span class="sd">    df[&quot;treatment&quot;] = &quot;A&quot;</span>
<span class="sd">    df.loc[(df[&quot;user&quot;] == &quot;User 5&quot;), &quot;treatment&quot;] = &quot;B&quot;</span>

<span class="sd">    SyntheticControlAnalysis(</span>
<span class="sd">        cluster_cols=[&quot;user&quot;], time_col=&quot;date&quot;, intervention_date=&quot;2022-01-15&quot;</span>
<span class="sd">    ).get_pvalue(df)</span>

<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">intervention_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
        <span class="n">time_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">hypothesis</span><span class="p">,</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_col</span> <span class="o">=</span> <span class="n">time_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intervention_date</span> <span class="o">=</span> <span class="n">intervention_date</span>

        <span class="k">if</span> <span class="n">time_col</span> <span class="ow">in</span> <span class="n">cluster_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;time columns should not be in cluster columns&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_experiment_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the weight of each donor&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pre_experiment_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No treatment unit found in the data.&quot;</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pre_experiment_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 0&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
            <span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pre_experiment_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 1&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
            <span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">get_w</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method adds a column with the synthetic results and filter only the treatment unit.</span>

<span class="sd">        First, it calculates the weights of each donor in the control group using the `fit_synthetic` method.</span>
<span class="sd">        It then uses these weights to create a synthetic control group that closely matches the treatment unit before the intervention.</span>
<span class="sd">        The synthetic control group is added to the treatment unit in the dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">synthetic</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="n">treatment_cluster</span><span class="p">]</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
            <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># add synthetic to treatment cluster</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">treatment_cluster</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">synthetic</span><span class="o">=</span><span class="n">synthetic</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_predict_synthetic</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">pre_experiment_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">treatment_cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the synthetic control model and predict the results for the treatment cluster.</span>
<span class="sd">        Args:</span>
<span class="sd">            df: The dataframe containing the data after the intervention.</span>
<span class="sd">            pre_experiment_df: The dataframe containing the data before the intervention.</span>
<span class="sd">            treatment_cluster: The name of the treatment cluster.</span>
<span class="sd">            verbose: If True, print the status of the optimization of weights.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The dataframe with the synthetic results added to the treatment cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">pre_experiment_df</span><span class="o">=</span><span class="n">pre_experiment_df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="o">=</span><span class="n">treatment_cluster</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">prediction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pvalue_based_on_hypothesis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ate</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">avg_effects</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the p-value of the analysis.</span>
<span class="sd">        1. Count how many times the average effect is greater than the real treatment unit</span>
<span class="sd">        2. Average it with the number of units. The result is the p-value using Fisher permutation exact test.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">avg_effects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">avg_effects</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">LESS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_effects</span> <span class="o">&lt;</span> <span class="n">ate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">GREATER</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_effects</span> <span class="o">&gt;</span> <span class="n">ate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">TWO_SIDED</span><span class="p">:</span>
            <span class="n">avg_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">avg_effects</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_effects</span> <span class="o">&gt;</span> <span class="n">ate</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="si">}</span><span class="s2"> is not a valid HypothesisEntries&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_treatment_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the first treatment cluster. The current implementation of Synthetic Control only accepts one treatment cluster.</span>
<span class="sd">        This will be left inside Synthetic class because it doesn&#39;t apply for other analyses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">treatment_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">treatment_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">treatment_df</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">treatment_cluster</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the p-value of the analysis.</span>
<span class="sd">        1. Calculate the average effect after intervention for each unit.</span>
<span class="sd">        2. Count how many times the average effect is greater than the real treatment unit</span>
<span class="sd">        3. Average it with the number of units. The result is the p-value using Fisher permutation test</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">treatment_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_treatment_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">synthetic_donors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cluster</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_point_estimate</span><span class="p">(</span>
                <span class="n">treatment_cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span>
        <span class="p">}</span>

        <span class="n">ate</span> <span class="o">=</span> <span class="n">synthetic_donors</span><span class="p">[</span><span class="n">treatment_cluster</span><span class="p">]</span>
        <span class="n">synthetic_donors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">treatment_cluster</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span> <span class="n">avg_effects</span><span class="o">=</span><span class="n">synthetic_donors</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">treatment_cluster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the point estimate for the treatment effect for a specified cluster by averaging across the time windows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_pre_experiment_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">treatment_cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">treatment_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_treatment_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_predict_synthetic</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;effect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;synthetic&quot;</span><span class="p">]</span>
        <span class="n">avg_effect</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">avg_effect</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_split_pre_experiment_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the dataframe into pre-experiment and experiment dataframes&quot;&quot;&quot;</span>
        <span class="n">pre_experiment_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervention_date</span><span class="p">)]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervention_date</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis._fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_fit</span><span class="p">(</span><span class="n">pre_experiment_df</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._fit" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the weight of each donor</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_experiment_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the weight of each donor&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pre_experiment_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No treatment unit found in the data.&quot;</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pre_experiment_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 0&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
        <span class="o">.</span><span class="n">T</span>
    <span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pre_experiment_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 1&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
        <span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">get_w</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis._get_treatment_cluster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_treatment_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._get_treatment_cluster" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the first treatment cluster. The current implementation of Synthetic Control only accepts one treatment cluster.
This will be left inside Synthetic class because it doesn't apply for other analyses</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_treatment_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the first treatment cluster. The current implementation of Synthetic Control only accepts one treatment cluster.</span>
<span class="sd">    This will be left inside Synthetic class because it doesn&#39;t apply for other analyses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">treatment_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">treatment_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">treatment_df</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">treatment_cluster</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis._predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_predict</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._predict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>This method adds a column with the synthetic results and filter only the treatment unit.</p>
<p>First, it calculates the weights of each donor in the control group using the <code>fit_synthetic</code> method.
It then uses these weights to create a synthetic control group that closely matches the treatment unit before the intervention.
The synthetic control group is added to the treatment unit in the dataframe.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_predict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method adds a column with the synthetic results and filter only the treatment unit.</span>

<span class="sd">    First, it calculates the weights of each donor in the control group using the `fit_synthetic` method.</span>
<span class="sd">    It then uses these weights to create a synthetic control group that closely matches the treatment unit before the intervention.</span>
<span class="sd">    The synthetic control group is added to the treatment unit in the dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">synthetic</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="n">treatment_cluster</span><span class="p">]</span>
        <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
        <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># add synthetic to treatment cluster</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">treatment_cluster</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">synthetic</span><span class="o">=</span><span class="n">synthetic</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis._split_pre_experiment_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_split_pre_experiment_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis._split_pre_experiment_df" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Split the dataframe into pre-experiment and experiment dataframes</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_split_pre_experiment_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split the dataframe into pre-experiment and experiment dataframes&quot;&quot;&quot;</span>
    <span class="n">pre_experiment_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervention_date</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervention_date</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_point_estimate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_point_estimate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_point_estimate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Calculate the point estimate for the treatment effect for a specified cluster by averaging across the time windows.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_point_estimate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">treatment_cluster</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the point estimate for the treatment effect for a specified cluster by averaging across the time windows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_pre_experiment_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">treatment_cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">treatment_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_treatment_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_predict_synthetic</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
    <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;effect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;synthetic&quot;</span><span class="p">]</span>
    <span class="n">avg_effect</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avg_effect</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis.
1. Calculate the average effect after intervention for each unit.
2. Count how many times the average effect is greater than the real treatment unit
3. Average it with the number of units. The result is the p-value using Fisher permutation test</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the p-value of the analysis.</span>
<span class="sd">    1. Calculate the average effect after intervention for each unit.</span>
<span class="sd">    2. Count how many times the average effect is greater than the real treatment unit</span>
<span class="sd">    3. Average it with the number of units. The result is the p-value using Fisher permutation test</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">treatment_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_treatment_cluster</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">synthetic_donors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">cluster</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_point_estimate</span><span class="p">(</span>
            <span class="n">treatment_cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span>
    <span class="p">}</span>

    <span class="n">ate</span> <span class="o">=</span> <span class="n">synthetic_donors</span><span class="p">[</span><span class="n">treatment_cluster</span><span class="p">]</span>
    <span class="n">synthetic_donors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">treatment_cluster</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">ate</span><span class="o">=</span><span class="n">ate</span><span class="p">,</span> <span class="n">avg_effects</span><span class="o">=</span><span class="n">synthetic_donors</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis.fit_predict_synthetic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_predict_synthetic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pre_experiment_df</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.fit_predict_synthetic" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Fit the synthetic control model and predict the results for the treatment cluster.
Args:
    df: The dataframe containing the data after the intervention.
    pre_experiment_df: The dataframe containing the data before the intervention.
    treatment_cluster: The name of the treatment cluster.
    verbose: If True, print the status of the optimization of weights.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataframe with the synthetic results added to the treatment cluster.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_predict_synthetic</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">pre_experiment_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">treatment_cluster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit the synthetic control model and predict the results for the treatment cluster.</span>
<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe containing the data after the intervention.</span>
<span class="sd">        pre_experiment_df: The dataframe containing the data before the intervention.</span>
<span class="sd">        treatment_cluster: The name of the treatment cluster.</span>
<span class="sd">        verbose: If True, print the status of the optimization of weights.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The dataframe with the synthetic results added to the treatment cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">pre_experiment_df</span><span class="o">=</span><span class="n">pre_experiment_df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">treatment_cluster</span><span class="o">=</span><span class="n">treatment_cluster</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.SyntheticControlAnalysis.pvalue_based_on_hypothesis" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pvalue_based_on_hypothesis</span><span class="p">(</span><span class="n">ate</span><span class="p">,</span> <span class="n">avg_effects</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.SyntheticControlAnalysis.pvalue_based_on_hypothesis" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis.
1. Count how many times the average effect is greater than the real treatment unit
2. Average it with the number of units. The result is the p-value using Fisher permutation exact test.</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pvalue_based_on_hypothesis</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ate</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">avg_effects</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the p-value of the analysis.</span>
<span class="sd">    1. Count how many times the average effect is greater than the real treatment unit</span>
<span class="sd">    2. Average it with the number of units. The result is the p-value using Fisher permutation exact test.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">avg_effects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">avg_effects</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">LESS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_effects</span> <span class="o">&lt;</span> <span class="n">ate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">GREATER</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_effects</span> <span class="o">&gt;</span> <span class="n">ate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">HypothesisEntries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">)</span> <span class="o">==</span> <span class="n">HypothesisEntries</span><span class="o">.</span><span class="n">TWO_SIDED</span><span class="p">:</span>
        <span class="n">avg_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">avg_effects</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_effects</span> <span class="o">&gt;</span> <span class="n">ate</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span><span class="si">}</span><span class="s2"> is not a valid HypothesisEntries&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="cluster_experiments.experiment_analysis.TTestClusteredAnalysis" class="doc doc-heading">
            <code>TTestClusteredAnalysis</code>


<a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="cluster_experiments.experiment_analysis.ExperimentAnalysis" href="#cluster_experiments.experiment_analysis.ExperimentAnalysis">ExperimentAnalysis</a></code></p>


        <p>Class to run T-test analysis on aggregated data</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cluster_cols</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of columns to use as clusters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the variable to measure</p>
              </div>
            </td>
            <td>
                  <code>&#39;target&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment_col</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the column containing the treatment variable</p>
              </div>
            </td>
            <td>
                  <code>&#39;treatment&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treatment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the treatment to use as the treated group</p>
              </div>
            </td>
            <td>
                  <code>&#39;B&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hypothesis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>one of "two-sided", "less", "greater" indicating the alternative hypothesis</p>
              </div>
            </td>
            <td>
                  <code>&#39;two-sided&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cluster_experiments.experiment_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">TTestClusteredAnalysis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
<span class="p">})</span>

<span class="n">TTestClusteredAnalysis</span><span class="p">(</span>
    <span class="n">cluster_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span>
    <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">get_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>






              <details class="quote">
                <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TTestClusteredAnalysis</span><span class="p">(</span><span class="n">ExperimentAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to run T-test analysis on aggregated data</span>

<span class="sd">    Arguments:</span>
<span class="sd">        cluster_cols: list of columns to use as clusters</span>
<span class="sd">        target_col: name of the column containing the variable to measure</span>
<span class="sd">        treatment_col: name of the column containing the treatment variable</span>
<span class="sd">        treatment: name of the treatment to use as the treated group</span>
<span class="sd">        hypothesis: one of &quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot; indicating the alternative hypothesis</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```python</span>
<span class="sd">    from cluster_experiments.experiment_analysis import TTestClusteredAnalysis</span>
<span class="sd">    import pandas as pd</span>

<span class="sd">    df = pd.DataFrame({</span>
<span class="sd">        &#39;x&#39;: [1, 2, 3, 4, 0, 0, 1, 1],</span>
<span class="sd">        &#39;treatment&#39;: [&quot;A&quot;, &quot;B&quot;, &quot;A&quot;, &quot;B&quot;] * 2,</span>
<span class="sd">        &#39;cluster&#39;: [1, 2, 3, 4, 1, 2, 3, 4],</span>
<span class="sd">    })</span>

<span class="sd">    TTestClusteredAnalysis(</span>
<span class="sd">        cluster_cols=[&#39;cluster&#39;],</span>
<span class="sd">        target_col=&#39;x&#39;,</span>
<span class="sd">    ).get_pvalue(df)</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;treatment&quot;</span><span class="p">,</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two-sided&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_col</span> <span class="o">=</span> <span class="n">target_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment</span> <span class="o">=</span> <span class="n">treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span> <span class="o">=</span> <span class="n">treatment_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="n">cluster_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span> <span class="o">=</span> <span class="n">hypothesis</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">        Arguments:</span>
<span class="sd">            df: dataframe containing the data to analyze</span>
<span class="sd">            verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">treatment_data</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 1&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
        <span class="n">control_data</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 0&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">treatment_data</span><span class="p">),</span> <span class="s2">&quot;treatment data should have more than 1 cluster&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_data</span><span class="p">),</span> <span class="s2">&quot;control data should have more than 1 cluster&quot;</span>
        <span class="n">t_test_results</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span>
            <span class="n">treatment_data</span><span class="p">,</span> <span class="n">control_data</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">t_test_results</span><span class="o">.</span><span class="n">pvalue</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a TTestClusteredAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
            <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
            <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.TTestClusteredAnalysis.analysis_pvalue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analysis_pvalue</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis.analysis_pvalue" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Returns the p-value of the analysis
Arguments:
    df: dataframe containing the data to analyze
    verbose (Optional): bool, prints the regression summary if True</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analysis_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the p-value of the analysis</span>
<span class="sd">    Arguments:</span>
<span class="sd">        df: dataframe containing the data to analyze</span>
<span class="sd">        verbose (Optional): bool, prints the regression summary if True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">treatment_data</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 1&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
    <span class="n">control_data</span> <span class="o">=</span> <span class="n">df_grouped</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">treatment_col</span><span class="si">}</span><span class="s2"> == 0&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">treatment_data</span><span class="p">),</span> <span class="s2">&quot;treatment data should have more than 1 cluster&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_data</span><span class="p">),</span> <span class="s2">&quot;control data should have more than 1 cluster&quot;</span>
    <span class="n">t_test_results</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span>
        <span class="n">treatment_data</span><span class="p">,</span> <span class="n">control_data</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hypothesis</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">t_test_results</span><span class="o">.</span><span class="n">pvalue</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="cluster_experiments.experiment_analysis.TTestClusteredAnalysis.from_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#cluster_experiments.experiment_analysis.TTestClusteredAnalysis.from_config" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Creates a TTestClusteredAnalysis object from a PowerConfig object</p>

            <details class="quote">
              <summary>Source code in <code>cluster_experiments/experiment_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a TTestClusteredAnalysis object from a PowerConfig object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">cluster_cols</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_cols</span><span class="p">,</span>
        <span class="n">target_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">treatment_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment_col</span><span class="p">,</span>
        <span class="n">treatment</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
        <span class="n">hypothesis</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hypothesis</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Maintained by David Masip.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
    
  </body>
</html>